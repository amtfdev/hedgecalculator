
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hedge Calculator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #22d3ee;
      --border: #1f2937;
      --ok: #34d399;
      --warn: #f59e0b;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 24px; border-bottom: 1px solid var(--border); background: rgba(17,24,39,0.7); position: sticky; top: 0; backdrop-filter: blur(8px); }
    h1 { margin: 0; font-size: 20px; letter-spacing: 0.2px; }
    main { padding: 24px; display: grid; gap: 24px; grid-template-columns: 420px 1fr; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    input, select, button, textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #0b1220; color: var(--text); outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(34,211,238,0.2); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .muted { color: var(--muted); font-size: 12px; }
    .btn { cursor: pointer; background: #0b1220; }
    .btn-primary { background: linear-gradient(90deg, #22d3ee, #60a5fa); color: #0b1220; font-weight: 600; }
    .btn-ghost { background: transparent; border-color: var(--border); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 14px; }
    th { text-align: left; color: var(--muted); font-weight: 600; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid var(--border); font-size: 12px;}
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .toolbar { display: flex; gap: 12px; align-items: center; justify-content: flex-end; margin-top: 12px; }
    footer { padding: 16px 24px; color: var(--muted); border-top: 1px solid var(--border); }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Hedge Calculator</h1>
  </header>
  <main>
    <section class="card">
      <div class="row">
        <div>
          <label>Index</label>
          <select id="index"></select>
        </div>
        <div>
          <label>Currency</label>
          <select id="currency">
            <option value="£">£</option>
            <option value="$">$</option>
          </select>
        </div>
      </div>

      <div class="row3" style="margin-top:12px">
        <div><label>Notional</label><input id="notional" type="number" value="2000000" step="1000"/></div>
        <div><label>Market Price</label><input id="marketPrice" type="number" value="9400" step="0.5"/></div>
        <div><label>Strike</label><input id="strike" type="number" value="9000" step="0.5"/></div>
      </div>

      <div class="row3" style="margin-top:12px">
        <div><label>Multiplier</label><input id="multiplier" type="number" value="10" step="1"/></div>
        <div><label>Fee / Contract</label><input id="feePerContract" type="number" value="10" step="0.1"/></div>
        <div>
          <label>Rounding</label>
          <select id="rounding">
            <option value="round">round</option>
            <option value="ceil">ceil</option>
            <option value="floor">floor</option>
          </select>
        </div>
      </div>

      <div style="margin-top:16px">
        <label>Options (expiry, offerPts)</label>
        <table id="opts">
          <thead><tr><th style="width:40%">Expiry</th><th>Offer (pts)</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="toolbar">
          <button class="btn btn-ghost" id="addRow">+ Add Row</button>
          <span class="muted">Tip: offerPts × multiplier = premium per contract</span>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn" id="selftest">Run Self-test</button>
        <button class="btn" id="healthz">Health</button>
        <button class="btn btn-primary" id="calc">Calculate</button>
        <button class="btn" id="export">Export JSON</button>
      </div>
    </section>

    <section class="card">
      <div id="summary" class="muted">Fill the form and hit Calculate.</div>
      <div style="overflow:auto; margin-top:8px">
        <table id="results" style="display:none">
          <thead>
            <tr>
              <th>Expiry</th>
              <th>Offer (pts)</th>
              <th>Premium/Contract</th>
              <th>Total Cost</th>
              <th>Breakeven</th>
              <th>Move vs Mkt</th>
              <th>Cost % Notional</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
  <footer>
    <span class="muted">Breakeven = (strike - feePerContract) - offerPts. Contracts = notional / (price × multiplier), rounded by mode.</span>
  </footer>

  <script>
    const $$ = (sel, el=document) => el.querySelector(sel);
    const $$$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const fmt = (n, dp=2) => (isFinite(n) ? Number(n).toFixed(dp) : "—");
    const pct = (n, dp=2) => (isFinite(n) ? (n*100).toFixed(dp) + "%" : "—");

    const state = {
      indexes: {},
    };

    async function init() {
      // Index metadata
      const r = await fetch('/indexes');
      state.indexes = await r.json();
      const idxSel = $('#index');
      Object.entries(state.indexes).forEach(([k,v]) => {
        const opt = document.createElement('option');
        opt.value = k; opt.textContent = `${k} — ${v.name}`;
        idxSel.appendChild(opt);
      });
      idxSel.value = 'FTSE100';
      onIndexChange();

      // Add an initial row
      addRow('2025-12', 163.5);

      // Wire actions
      $('#addRow').addEventListener('click', () => addRow('', ''));
      $('#calc').addEventListener('click', doCalc);
      $('#export').addEventListener('click', doExport);
      $('#selftest').addEventListener('click', doSelfTest);
      $('#healthz').addEventListener('click', async () => {
        const out = await (await fetch('/healthz')).json();
        toast(JSON.stringify(out));
      });
      $('#index').addEventListener('change', onIndexChange);
    }

    function $(s){ return $$(s); }

    function onIndexChange() {
      const key = $('#index').value;
      const meta = state.indexes[key] || { multiplier: 1, currency: '£' };
      $('#multiplier').value = meta.multiplier;
      $('#currency').value = meta.currency;
      $('#summary').innerHTML = `<span class="pill">${key}</span> <span class="muted">${meta.name}</span>`;
    }

    function addRow(expiry, offerPts) {
      const tb = $('#opts tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" placeholder="YYYY-MM" value="${expiry || ''}" /></td>
        <td><input type="number" step="0.1" value="${offerPts || ''}" /></td>
        <td style="width:40px"><button class="btn" title="Remove">✕</button></td>
      `;
      tr.querySelector('button').addEventListener('click', () => tr.remove());
      tb.appendChild(tr);
    }

    function readInputs() {
      const options = $$$('#opts tbody tr').map(tr => {
        const [expiryI, offerI] = $$$('input', tr);
        return { expiry: expiryI.value.trim(), offerPts: Number(offerI.value) };
      }).filter(x => x.expiry && isFinite(x.offerPts));

      return {
        index: $('#index').value,
        notional: Number($('#notional').value),
        marketPrice: Number($('#marketPrice').value),
        strike: Number($('#strike').value),
        multiplier: Number($('#multiplier').value),
        feePerContract: Number($('#feePerContract').value),
        rounding: $('#rounding').value,
        options,
        currency: $('#currency').value
      };
    }

    async function doCalc() {
      const payload = readInputs();
      const res = await fetch('/calc', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
      if (!res.ok) { toast('Error running calc'); return; }
      const data = await res.json();
      renderResults(payload.currency, data);
    }

    function renderResults(currency, data) {
      const s = data.summary;
      $('#summary').innerHTML = \`<b>Contracts:</b> \${s.contracts} &nbsp; <span class="muted">Notional covered:</span> \${currency} \${fmt(s.notionalCovered, 0)}\`;
      const tb = $('#results tbody');
      tb.innerHTML = '';
      for (const row of data.rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td>\${row.expiry}</td>
          <td>\${fmt(row.offerPts)}</td>
          <td>\${currency} \${fmt(row.premiumPerContract)}</td>
          <td>\${currency} \${fmt(row.totalCost)}</td>
          <td>\${fmt(row.breakevenPrice)}</td>
          <td class="\${row.pctMove < 0 ? 'ok' : 'warn'}">\${pct(row.pctMove)}</td>
          <td>\${pct(row.costPct)}</td>\`;
        tb.appendChild(tr);
      }
      $('#results').style.display = data.rows.length ? '' : 'none';
    }

    async function doExport() {
      const inputs = readInputs();
      const res = await fetch('/export', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ inputs, notes: '' }) });
      if (!res.ok) { toast('Error exporting'); return; }
      const data = await res.json();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      a.href = url; a.download = \`hedge_export_\${ts}.json\`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    async function doSelfTest() {
      const r = await fetch('/selftest'); const d = await r.json();
      const ok = d.ok ? 'PASS' : 'FAIL';
      toast(\`Self-test: \${ok}\n\` + d.results.join('\n'));
    }

    function toast(msg) {
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.cssText = 'position:fixed;right:16px;bottom:16px;background:#0b1220;color:#e5e7eb;border:1px solid #1f2937;padding:12px 14px;border-radius:10px;max-width:60ch;white-space:pre-line;z-index:9999';
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 4200);
    }

    init();
  </script>
</body>
</html>
